<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Smart Anniversary Collage Final</title>

<link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=Poppins:wght@400;700&display=swap" rel="stylesheet">
<link href="https://fonts.cdnfonts.com/css/blackjack" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
/* GLOBAL & MOBILE BASICS */
body{
    margin:0;
    font-family:Poppins;
    background:#111;
    color:#fff;
    display:flex;
    flex-direction:column;
    align-items:center;
    overflow-x: hidden;
    padding-bottom: 80px;
}

.app{
    display:flex;
    flex-direction: column;
    align-items: center;
    gap:20px;
    width: 100%;
    box-sizing: border-box;
    padding: 20px;
}

/* --- CANVAS WRAPPER (This makes it work on Mobile) --- */
#canvas-wrapper-outer {
    width: 100%;
    display: flex;
    justify-content: center;
    overflow: hidden; 
    position: relative;
    /* Height is set by JS */
}

/* --- CANVAS (TUMHARI EXACT CSS) --- */
#canvas{
    width:800px;
    height:1130px;
    /* Important Fix for Mobile: Force Minimum Width */
    min-width: 800px;
    min-height: 1130px;
    
    background:#000;
    position:relative;
    overflow:hidden;
    box-shadow: 0 0 20px rgba(0,0,0,0.5);
    transform-origin: top center;
}

/* --- TEMPLATE & LAYOUT (TUMHARA EXACT CODE) --- */
#bg-image{
    position:absolute; inset:0; width:100%; height:100%; object-fit:contain; z-index:0; pointer-events: none;
}

/* DATE */
#overlay-date-container{
    position:absolute; top:10%; left:10%; width:22%; text-align:center; z-index:5; pointer-events: none;
}
#overlay-date, #overlay-year{
    font-family:'BlackJack',cursive; color:#fff; line-height:0.8; text-shadow:3px 3px 6px rgba(0,0,0,0.8);
    font-weight: bold;
}

/* PARAGRAPH (Tumhari Settings: Top 29%, Left 2%, Width 36%) */
#overlay-para{
    position:absolute;
    top:29%;
    left:2%;
    width:36%;
    font-family:'Dancing Script',cursive;
    font-size:1.5rem;
    line-height:1.6;
    white-space:pre-wrap;
    z-index:6;
    pointer-events: none;
    font-weight: 900 !important;
    -webkit-text-stroke: 0.5px white; /* Isse font thick ho jayega */
    text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
}

/* NAMES (Tumhari Settings: Bottom 1%, Left 32%) */
#overlay-names{
    position:absolute;
    bottom:1%;
    left:32%;
    right:2%;
    text-align:center;
    font-family:'Dancing Script',cursive;
    font-size:3.8rem;
    white-space:nowrap;
    z-index:6;
    pointer-events: none;
}

/* AREA 1 (Tumhari Settings) */
#area1{
    position:absolute;
    top:15%;
    right:27%;
    width:33%;
    height:23%;
    overflow:hidden;
    border-radius:10px;
    z-index:4;
}

/* AREA 2 (Tumhari Settings: Width 58%, Bottom 10%) */
#area2{
    position:absolute;
    top:39%;
    bottom:10%;
    right:2%;
    width:58%;
    display:grid;
    gap:10px;
    z-index:4;
    grid-auto-rows:1fr;
}

/* PHOTO STYLING */
.photo{
    position:relative; overflow:hidden; border-radius:12px; cursor:pointer; 
    width: 100%; height: 100%; background: #222; 
    -webkit-tap-highlight-color: transparent;
}
.inner{ position:absolute; top:0; left:0; transform-origin:top left; width: 100%; height: 100%; }
.inner img{ display:block; max-width:none; position: absolute; top: 0; left: 0; }
.photo.selected{ outline:4px solid red; }

/* CONTROLS (Mobile Friendly) */
.controls{
    width: 100%;
    max-width: 400px;
    background:#1a1a1a;
    padding:20px;
    border-radius:12px;
    box-shadow:0 -5px 20px rgba(0,0,0,0.6);
    box-sizing: border-box;
    z-index: 100;
}

input, textarea{
    width:100%; padding:10px; margin-bottom:12px; border-radius:6px; 
    border:1px solid #444; background:#222; color:#fff; box-sizing: border-box; font-size: 16px;
}

button{
    width:100%; padding:15px; background:linear-gradient(45deg,#ff3333,#ffcc00);
    border:none; border-radius:8px; cursor:pointer; font-weight:bold; 
    margin-bottom: 5px; font-size: 1.1rem; color: #000;
}

/* CROP MODAL (Updated for Touch) */
#cropModal{
    position:fixed; inset:0; background:rgba(0,0,0,0.95); display:none;
    flex-direction: column; justify-content:center; align-items:center; z-index:9999; padding: 20px;
}
.crop-wrapper{
    background:#1a1a1a; padding:15px; border-radius:12px; text-align: center; 
    border: 1px solid #333; width: 100%; max-width: 400px; box-sizing: border-box;
}
.crop-box{
    position:relative; overflow:hidden; background:#000; margin: 0 auto; 
    border: 2px solid #555; cursor: grab; touch-action: none;
}
.crop-box:active { cursor: grabbing; }
.crop-inner{ position:absolute; top:0; left:0; transform-origin: top left; width: 100%; height: 100%; }
.crop-inner img { max-width: none; display: block; position: absolute; top: 0; left: 0; }

.zoom-controls { display: flex; justify-content: center; gap: 20px; margin: 15px 0; }
.zoom-btn { width: 50px; height: 50px; border-radius: 50%; background: #333; color: #fff; font-size: 1.5rem; border: 1px solid #555; display: flex; align-items: center; justify-content: center; padding: 0; }
.crop-controls { margin-top: 10px; display: flex; gap: 10px; }
.crop-controls button { padding: 12px; }

</style>
</head>

<body>

<h2>Smart Anniversary Collage</h2>
<div style="font-size:0.8rem; color:#888; margin-bottom:10px;">Mobile: Double Tap to Edit Photo</div>

<div class="app">

    <div id="canvas-wrapper-outer">
        <div id="canvas">
            <img id="bg-image">

            <div id="overlay-date-container">
                <div id="overlay-date" style="font-size:3rem;">14 Feb</div>
                <div id="overlay-year" style="font-size:3rem;">2024</div>
            </div>

            <div id="area1"></div>
            <div id="overlay-para"></div>
            <div id="area2"></div>
            <div id="overlay-names">Daivik‚ù£Ô∏èRadhika</div>
        </div>
    </div>

    <div class="controls">
        <button onclick="downloadImage()">Download A4 HD ‚¨áÔ∏è</button>
        <hr style="border-color:#333; margin: 15px 0;">

        <label>Upload Template</label>
        <input type="file" id="bg-input" accept="image/*">

        <label>Upload Photos</label>
        <input type="file" id="photo-input" multiple accept="image/*">

        <label>Date</label>
        <input type="text" id="input-date" value="14 Feb">

        <label>Year</label>
        <input type="text" id="input-year" value="2024">

        <label>Date Size</label>
        <input type="range" min="2" max="4" step="0.1" value="3"
        oninput="updateDateSize(this.value)">

        <label>Paragraph</label>
        <textarea id="input-msg" rows="5">¬† ¬† ¬† ¬† ¬†Happy Anniversary¬†
Today üíñ marks the beginning of¬†your years üíó togetherüë©‚Äç‚ù§Ô∏è‚Äçüë®‚ú® . May your bond üíû continue to grow stronger with each passing year üïäÔ∏è. Here‚Äôs a small gift üéÅ to celebrate üéâ the big Love üíï you share üí´ may it bring a little extra joy to your special day!ü•Ç‚ú® Cheers to many more years of laughter, love, and unforgettable memories together üéä‚ù§Ô∏è</textarea>

        <label>Name 1</label>
        <input type="text" id="input-name1" value="Daivik">

        <label>Name 2</label>
        <input type="text" id="input-name2" value="Radhika">

        <label>Name Size</label>
        <input type="range" min="2" max="6" step="0.1" value="3.8"
        oninput="document.getElementById('overlay-names').style.fontSize=this.value+'rem'">
    </div>

</div>

<div id="cropModal">
    <div class="crop-wrapper">
        <h3 style="margin-top:0; color:#ddd; font-size:1.2rem;">Adjust Photo</h3>
        <div class="crop-box" id="cropBox">
            <div class="crop-inner" id="cropInner">
                <img id="cropImg">
            </div>
        </div>
        <div class="zoom-controls">
            <button class="zoom-btn" onclick="zoomOut()">-</button>
            <button class="zoom-btn" onclick="zoomIn()">+</button>
        </div>
        <div class="crop-controls">
            <button onclick="applyCrop()" style="background:#28a745; color:white;">Apply</button>
            <button onclick="closeCrop()" style="background:#555; color:white;">Cancel</button>
        </div>
    </div>
</div>

<script>
// --- ELEMENTS ---
const bgInput=document.getElementById("bg-input");
const bgImage=document.getElementById("bg-image");
const photoInput=document.getElementById("photo-input");
const area1=document.getElementById("area1");
const area2=document.getElementById("area2");
const canvas = document.getElementById("canvas");
const wrapperOuter = document.getElementById("canvas-wrapper-outer");

const cropModal = document.getElementById("cropModal");
const cropBox = document.getElementById("cropBox");
const cropInner = document.getElementById("cropInner");
const cropImg = document.getElementById("cropImg");
let currentInner = null;
let cropState = {x:0, y:0, scale:1};

let selected=null;

/* --- MOBILE RESPONSIVE ENGINE (Important) --- */
function responsiveScale() {
    const screenWidth = window.innerWidth;
    const canvasWidth = 800; 
    const canvasHeight = 1130;
    const padding = 20;

    if (screenWidth < canvasWidth + padding) {
        const scaleFactor = (screenWidth - padding) / canvasWidth;
        canvas.style.transform = `scale(${scaleFactor})`;
        wrapperOuter.style.height = `${canvasHeight * scaleFactor}px`;
    } else {
        canvas.style.transform = "none";
        wrapperOuter.style.height = "auto";
    }
}
window.addEventListener("resize", responsiveScale);
window.addEventListener("load", responsiveScale);
responsiveScale();

/* --- TEMPLATE --- */
bgInput.addEventListener("change",e=>{
    const file=e.target.files[0];
    if(!file) return;
    const reader=new FileReader();
    reader.onload=ev=> bgImage.src=ev.target.result;
    reader.readAsDataURL(file);
});

/* --- PHOTO LOGIC (Tumhara Style) --- */
function applyTransform(el){
    const x = parseFloat(el.dataset.x) || 0;
    const y = parseFloat(el.dataset.y) || 0;
    const scale = parseFloat(el.dataset.scale) || 1;
    el.style.transform = `translate(${x}px, ${y}px) scale(${scale})`;
}

photoInput.addEventListener("change",e=>{
    area1.innerHTML="";
    area2.innerHTML="";
    const files=[...e.target.files];
    if(files.length<1) return;

    files.forEach((file,index)=>{
        const reader=new FileReader();
        reader.onload=ev=>{
            const div=document.createElement("div");
            div.className="photo";
            const inner=document.createElement("div");
            inner.className="inner";
            inner.dataset.x = 0; inner.dataset.y = 0; inner.dataset.scale = 1;
            
            const img=document.createElement("img");
            img.src=ev.target.result;
            inner.appendChild(img);
            div.appendChild(inner);

            img.onload = function(){
                const boxW = div.clientWidth;
                const boxH = div.clientHeight;
                const imgW = img.naturalWidth;
                const imgH = img.naturalHeight;
                if(!boxW || !boxH || !imgW || !imgH) return;
                
                // AUTO FIT
                const scale = Math.max(boxW/imgW, boxH/imgH);
                inner.dataset.scale = scale;
                inner.dataset.x = (boxW - imgW*scale)/2;
                inner.dataset.y = (boxH - imgH*scale)/2;
                applyTransform(inner);
            };

            div.onclick = () => handlePhotoClick(div);
            
            // Double Tap for Mobile
            let lastTap = 0;
            div.addEventListener('touchend', function(e) {
                const currentTime = new Date().getTime();
                const tapLength = currentTime - lastTap;
                if (tapLength < 300 && tapLength > 0) {
                    e.preventDefault(); openCrop(inner, div);
                }
                lastTap = currentTime;
            });
            div.ondblclick = (e) => { e.stopPropagation(); openCrop(inner, div); };

            if(index===0) area1.appendChild(div);
            else area2.appendChild(div);
        };
        reader.readAsDataURL(file);
    });
    
    setTimeout(()=>{ 
        applyLayout(files.length-1); 
        responsiveScale();
    }, 200);
});

/* --- SWAP LOGIC --- */
function handlePhotoClick(div){
    if(!selected){
        selected=div; div.classList.add("selected");
    } else if(selected === div){
        selected.classList.remove("selected"); selected = null;
    } else {
        const selInner = selected.querySelector(".inner");
        const targetInner = div.querySelector(".inner");
        
        const tempSrc = selInner.querySelector("img").src;
        selInner.querySelector("img").src = targetInner.querySelector("img").src;
        targetInner.querySelector("img").src = tempSrc;

        const swapData = (a, b) => {
            const tempX = a.dataset.x; const tempY = a.dataset.y; const tempScale = a.dataset.scale;
            a.dataset.x = b.dataset.x; a.dataset.y = b.dataset.y; a.dataset.scale = b.dataset.scale;
            b.dataset.x = tempX; b.dataset.y = tempY; b.dataset.scale = tempScale;
        };
        swapData(selInner, targetInner);
        applyTransform(selInner);
        applyTransform(targetInner);

        selected.classList.remove("selected"); selected=null;
    }
}

/* --- GRID LAYOUT (Tumhara Exact Logic) --- */
function applyLayout(count){
    area2.style.gridTemplateColumns="";
    [...area2.children].forEach(el=>{ el.style.gridRow=""; el.style.gridColumn=""; });
    
    if(count==1) area2.style.gridTemplateColumns="1fr";
    else if(count==2) area2.style.gridTemplateColumns="repeat(2,1fr)";
    else if(count==3){ area2.style.gridTemplateColumns="2fr 1fr"; area2.children[0].style.gridRow="span 2"; }
    else if(count==4) area2.style.gridTemplateColumns="repeat(2,1fr)";
    else if(count==5){ area2.style.gridTemplateColumns="repeat(2,1fr)"; area2.children[4].style.gridColumn="span 2"; }
    else if(count==6) area2.style.gridTemplateColumns="repeat(3,1fr)";
    else if(count==7){ area2.style.gridTemplateColumns="repeat(3,1fr)"; area2.children[6].style.gridColumn="span 3"; }
    else area2.style.gridTemplateColumns="repeat(4,1fr)";
}

/* --- TEXT UPDATES --- */
function updateDateSize(val){
    document.getElementById("overlay-date").style.fontSize=val+"rem";
    document.getElementById("overlay-year").style.fontSize=val+"rem";
}
document.getElementById("input-date").oninput=e=>document.getElementById("overlay-date").innerText=e.target.value;
document.getElementById("input-year").oninput=e=>document.getElementById("overlay-year").innerText=e.target.value;
const paraInput=document.getElementById("input-msg");
const paraOverlay=document.getElementById("overlay-para");
paraOverlay.innerText=paraInput.value;
paraInput.addEventListener("input",()=>paraOverlay.innerText=paraInput.value);
function updateNames(){
    document.getElementById("overlay-names").innerHTML=document.getElementById("input-name1").value+"‚ù£Ô∏è"+document.getElementById("input-name2").value;
}
document.getElementById("input-name1").oninput=updateNames;
document.getElementById("input-name2").oninput=updateNames;

/* --- CROP MODAL (With Touch) --- */
function openCrop(inner, div){
    currentInner = inner;
    cropBox.style.width = div.clientWidth + "px";
    cropBox.style.height = div.clientHeight + "px";
    cropImg.src = inner.querySelector("img").src;
    
    cropState.x = parseFloat(inner.dataset.x) || 0;
    cropState.y = parseFloat(inner.dataset.y) || 0;
    cropState.scale = parseFloat(inner.dataset.scale) || 1;
    
    updateCropView();
    cropModal.style.display = "flex";
    setupCropInteraction();
}
function updateCropView(){
    cropInner.style.transform = `translate(${cropState.x}px, ${cropState.y}px) scale(${cropState.scale})`;
}
function zoomIn() { cropState.scale += 0.05; updateCropView(); }
function zoomOut() { cropState.scale = Math.max(0.1, cropState.scale - 0.1); updateCropView(); }

function setupCropInteraction() {
    let startX, startY, isDragging = false;
    
    const handleStart = (clientX, clientY) => {
        isDragging = true;
        startX = clientX - cropState.x;
        startY = clientY - cropState.y;
    };
    const handleMove = (clientX, clientY) => {
        if(!isDragging) return;
        cropState.x = clientX - startX;
        cropState.y = clientY - startY;
        updateCropView();
    };

    cropBox.ontouchstart = e => handleStart(e.touches[0].clientX, e.touches[0].clientY);
    cropBox.ontouchmove = e => { e.preventDefault(); handleMove(e.touches[0].clientX, e.touches[0].clientY); };
    cropBox.ontouchend = () => { isDragging = false; };
    
    cropBox.onmousedown = e => { e.preventDefault(); handleStart(e.clientX, e.clientY); };
    document.onmousemove = e => { if(isDragging) { e.preventDefault(); handleMove(e.clientX, e.clientY); } };
    document.onmouseup = () => { isDragging = false; };
}

function applyCrop(){
    if(currentInner){
        currentInner.dataset.x = cropState.x;
        currentInner.dataset.y = cropState.y;
        currentInner.dataset.scale = cropState.scale;
        applyTransform(currentInner);
    }
    closeCrop();
}
function closeCrop(){ cropModal.style.display = "none"; }

/* --- A4 HD DOWNLOAD --- */
function downloadImage(){
    const currentTransform = canvas.style.transform;
    canvas.style.transform = "none"; 
    window.scrollTo(0,0);

    html2canvas(document.getElementById("canvas"),{
        scale: 3, 
        useCORS: true,
        allowTaint: true,
        backgroundColor:"#000",
        width: 800,
        height: 1130,
        windowWidth: 1280,
        scrollY: 0,
        x: 0,
        y: 0
    }).then(canvasEl=>{
        const link=document.createElement("a");
        link.download="My_Anniversary_Collage.jpg";
        link.href=canvasEl.toDataURL("image/jpeg", 0.9);
        link.click();
        
        canvas.style.transform = currentTransform;
    }).catch(err => {
        console.error(err);
        canvas.style.transform = currentTransform;
    });
}

</script>
</body>

</html>