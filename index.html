<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Smart Anniversary Collage Mobile</title>

<link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Poppins:wght@400;700&display=swap" rel="stylesheet">
<link href="https://fonts.cdnfonts.com/css/blackjack" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
body{
margin:0;
font-family:Poppins;
background:#111;
color:#fff;
display:flex;
flex-direction:column;
align-items:center;
overflow-x: hidden; /* Prevent horizontal scroll on mobile */
padding-bottom: 50px;
}

.app{
display:flex;
gap:20px;
padding:20px;
flex-wrap:wrap;
justify-content:center;
width: 100%;
box-sizing: border-box;
}

/* CONTROLS - Mobile Friendly */
.controls{
width:360px;
max-width: 100%; /* Fit mobile screen */
background:#1a1a1a;
padding:20px;
border-radius:12px;
box-shadow:0 0 20px rgba(0,0,0,0.6);
box-sizing: border-box;
order: 2; /* On mobile, controls below canvas (optional, currently logic keeps side by side or wrap) */
}

@media (max-width: 850px) {
    .app {
        flex-direction: column;
        align-items: center;
        padding: 10px;
    }
    .controls {
        width: 100%;
        order: 2;
    }
    /* Canvas Wrapper for scaling */
    #canvas-wrapper {
        order: 1;
        width: 100%;
        display: flex;
        justify-content: center;
        overflow: hidden;
        margin-bottom: 20px;
    }
}

input, textarea{
width:100%;
padding:8px;
margin-bottom:10px;
border-radius:6px;
border:1px solid #444;
background:#222;
color:#fff;
box-sizing: border-box;
}

button{
width:100%;
padding:12px;
background:linear-gradient(45deg,#ff3333,#ffcc00);
border:none;
border-radius:8px;
cursor:pointer;
font-weight:bold;
margin-bottom: 5px;
font-size: 1rem;
}

/* CANVAS CONTAINER (To handle scaling on mobile) */
#canvas-wrapper {
    position: relative;
    /* Height will be set via JS */
}

/* ACTUAL CANVAS */
#canvas{
width:800px;
height:1130px;
background:#000;
position:relative;
overflow:hidden;
transform-origin: top center; /* Important for scaling */
box-shadow: 0 0 20px rgba(0,0,0,0.5);
}

#bg-image{
position:absolute;
inset:0;
width:100%;
height:100%;
object-fit:contain;
z-index:0;
pointer-events: none;
}

/* DATE */
#overlay-date-container{
position:absolute;
top:10%;
left:10%;
width:22%;
text-align:center;
z-index:5;
pointer-events: none;
}

#overlay-date,
#overlay-year{
font-family:'BlackJack',cursive;
color:#fff;
line-height:0.8;
text-shadow:3px 3px 6px rgba(0,0,0,0.8);
}

/* PARAGRAPH */
#overlay-para{
position:absolute;
top:29%;
left:2%;
width:36%;
font-family:'Dancing Script',cursive;
font-size:1.5rem;
line-height:1.6;
white-space:pre-wrap;
z-index:6;
pointer-events: none;
}

/* NAMES */
#overlay-names{
position:absolute;
bottom:1%;
left:32%;
right:2%;
text-align:center;
font-family:'Dancing Script',cursive;
font-size:3.8rem;
white-space:nowrap;
z-index:6;
pointer-events: none;
}

/* AREA 1 */
#area1{
position:absolute;
top:15%;
right:27%;
width:33%;
height:23%;
overflow:hidden;
border-radius:10px;
z-index:4;
}

/* AREA 2 */
#area2{
position:absolute;
top:39%;
bottom:10%;
right:2%;
width:58%;
display:grid;
gap:10px;
z-index:4;
grid-auto-rows:1fr;
}

/* PHOTO CONTAINER */
.photo{
position:relative;
overflow:hidden;
border-radius:12px;
cursor:pointer;
width: 100%;
height: 100%;
background: #222;
-webkit-tap-highlight-color: transparent; /* Remove blue highlight on tap */
}

/* INNER DIV */
.inner{
position:absolute;
top:0;
left:0;
transform-origin:top left; 
width: 100%;
height: 100%;
}

/* IMAGE */
.inner img{
display:block;
max-width:none; 
position: absolute;
top: 0;
left: 0;
}

.photo.selected{
outline:4px solid red;
}

/* --- ADVANCED CROP MODAL STYLES --- */
#cropModal{
position:fixed;
inset:0;
background:rgba(0,0,0,0.95);
display:none;
flex-direction: column;
justify-content:center;
align-items:center;
z-index:9999;
padding: 20px;
}

.crop-wrapper{
background:#1a1a1a;
padding:15px;
border-radius:12px;
text-align: center;
border: 1px solid #333;
width: 100%;
max-width: 400px; /* Limit width on tablets */
box-sizing: border-box;
}

.crop-box{
position:relative;
overflow:hidden;
background:#000;
margin: 0 auto;
border: 2px solid #555;
cursor: grab;
touch-action: none; /* Crucial for touch dragging */
}

.crop-box:active {
cursor: grabbing;
}

.crop-inner{
position:absolute;
top:0;
left:0;
transform-origin: top left; 
width: 100%;
height: 100%;
}

.crop-inner img {
max-width: none;
display: block;
position: absolute;
top: 0;
left: 0;
}

/* Zoom Controls for Mobile */
.zoom-controls {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin: 10px 0;
}

.zoom-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #333;
    color: #fff;
    font-size: 1.2rem;
    border: 1px solid #555;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
}

.crop-controls {
margin-top: 10px;
display: flex;
gap: 10px;
justify-content: center;
}

.crop-controls button {
width: auto;
flex: 1;
padding: 10px;
margin: 0;
}

/* Mobile Hint Text */
.mobile-hint {
    display: none;
    font-size: 0.8rem;
    color: #aaa;
    margin-bottom: 10px;
    text-align: center;
}
@media (max-width: 850px) {
    .mobile-hint { display: block; }
}

</style>
</head>

<body>

<h2>Smart Anniversary Collage</h2>
<div class="mobile-hint">Tap to Select. Tap another to Swap.<br>Double Tap to Crop/Edit.</div>

<div class="app">

<div id="canvas-wrapper">
    <div id="canvas">
        <img id="bg-image">

        <div id="overlay-date-container">
            <div id="overlay-date" style="font-size:3rem;">14 Feb</div>
            <div id="overlay-year" style="font-size:3rem;">2024</div>
        </div>

        <div id="area1"></div>
        <div id="overlay-para"></div>
        <div id="area2"></div>
        <div id="overlay-names">Daivik‚ù£Ô∏èRadhika</div>
    </div>
</div>

<div class="controls">

<label>Upload Template</label>
<input type="file" id="bg-input" accept="image/*">

<label>Upload Photos</label>
<input type="file" id="photo-input" multiple accept="image/*">

<label>Date</label>
<input type="text" id="input-date" value="14 Feb">

<label>Year</label>
<input type="text" id="input-year" value="2024">

<label>Date Size</label>
<input type="range" min="2" max="4" step="0.1" value="3"
oninput="updateDateSize(this.value)">

<label>Paragraph</label>
<textarea id="input-msg"> ¬† ¬† ¬† ¬† Happy Anniversary 
Today üíñ marks the beginning of ¬†your years üíó together üë©‚Äç‚ù§Ô∏è‚Äçüë®‚ú®. May your bond üíû continue to grow stronger üíù with each passing year üåüüïäÔ∏è. Here‚Äôs a small gift üéÅ to celebrate üéâ the big Love üíï you share üí´ may it bring a little extra joy üíì to your special day! ü•Çüíê‚ú® Cheers to many more years of laughter, love üíñ, and unforgettable memories together üéä‚ù§Ô∏è</textarea>

<label>Name 1</label>
<input type="text" id="input-name1" value="Daivik">

<label>Name 2</label>
<input type="text" id="input-name2" value="Radhika">

<label>Name Size</label>
<input type="range" min="2" max="6" step="0.1" value="3.8"
oninput="document.getElementById('overlay-names').style.fontSize=this.value+'rem'">

<button onclick="downloadImage()">Download HD</button>

</div>

</div>

<div id="cropModal">
<div class="crop-wrapper">
<h3 style="margin-top:0; color:#ddd; font-size:1.2rem;">Adjust Photo</h3>
<div class="crop-box" id="cropBox">
<div class="crop-inner" id="cropInner">
<img id="cropImg">
</div>
</div>

<div class="zoom-controls">
    <button class="zoom-btn" onclick="zoomOut()">-</button>
    <button class="zoom-btn" onclick="zoomIn()">+</button>
</div>

<div class="crop-controls">
<button onclick="applyCrop()" style="background:#28a745;">Apply</button>
<button onclick="closeCrop()" style="background:#555;">Cancel</button>
</div>
</div>
</div>

<script>

const bgInput=document.getElementById("bg-input");
const bgImage=document.getElementById("bg-image");
const photoInput=document.getElementById("photo-input");
const area1=document.getElementById("area1");
const area2=document.getElementById("area2");
const canvasWrapper = document.getElementById("canvas-wrapper");
const canvas = document.getElementById("canvas");

/* CROP VARIABLES */
const cropModal = document.getElementById("cropModal");
const cropBox = document.getElementById("cropBox");
const cropInner = document.getElementById("cropInner");
const cropImg = document.getElementById("cropImg");
let currentInner = null;
let cropState = {x:0, y:0, scale:1};

let selected=null;
let draggedItem=null;

/* --- RESPONSIVE SCALING LOGIC --- */
function scaleCanvas() {
    const screenWidth = window.innerWidth;
    const padding = 40; 
    const targetWidth = 800;
    
    // Only scale if screen is smaller than canvas
    if (screenWidth < targetWidth + padding) {
        const scale = (screenWidth - padding) / targetWidth;
        canvas.style.transform = `scale(${scale})`;
        // Adjust height of wrapper so controls don't overlap
        canvasWrapper.style.height = `${1130 * scale}px`;
        canvasWrapper.style.width = `${800 * scale}px`; // Center align hack
    } else {
        canvas.style.transform = "none";
        canvasWrapper.style.height = "auto";
        canvasWrapper.style.width = "auto";
    }
}
window.addEventListener("resize", scaleCanvas);
// Call initially
scaleCanvas();

/* TEMPLATE */
bgInput.addEventListener("change",e=>{
const file=e.target.files[0];
if(!file) return;
const reader=new FileReader();
reader.onload=ev=> bgImage.src=ev.target.result;
reader.readAsDataURL(file);
});

/* HELPER: Apply Transform based on Dataset */
function applyTransform(el){
const x = parseFloat(el.dataset.x) || 0;
const y = parseFloat(el.dataset.y) || 0;
const scale = parseFloat(el.dataset.scale) || 1;
el.style.transform = `translate(${x}px, ${y}px) scale(${scale})`;
}

/* REORDER & DRAG LOGIC (Desktop) */
function enableReorder(div){
div.setAttribute("draggable","true");
div.addEventListener("dragstart",()=>{ draggedItem = div; });
div.addEventListener("dragover",e=>{ e.preventDefault(); });
div.addEventListener("drop",e=>{
e.preventDefault();
if(draggedItem && draggedItem !== div){
div.parentNode.insertBefore(draggedItem, div);
}
});
}

/* --- ADVANCED CROP LOGIC (MOBILE OPTIMIZED) --- */
function openCrop(inner, div){
currentInner = inner;

// 1. Match Box Size EXACTLY
cropBox.style.width = div.clientWidth + "px";
cropBox.style.height = div.clientHeight + "px";

// 2. Set Image Source
cropImg.src = inner.querySelector("img").src;

// 3. Get Current Transform State
cropState.x = parseFloat(inner.dataset.x) || 0;
cropState.y = parseFloat(inner.dataset.y) || 0;
cropState.scale = parseFloat(inner.dataset.scale) || 1;

// 4. Update View immediately
updateCropView();
cropModal.style.display = "flex";

// 5. Setup Mouse & TOUCH Events for Panning
setupCropInteraction();
}

function updateCropView(){
cropInner.style.transform = `translate(${cropState.x}px, ${cropState.y}px) scale(${cropState.scale})`;
}

// Zoom Helper Functions (For Mobile Buttons)
function zoomIn() {
    cropState.scale += 0.1;
    updateCropView();
}
function zoomOut() {
    cropState.scale = Math.max(0.1, cropState.scale - 0.1);
    updateCropView();
}

function setupCropInteraction() {
    let startX, startY, isDragging = false;

    // --- MOUSE EVENTS ---
    cropBox.onmousedown = e => {
        e.preventDefault();
        isDragging = true;
        startX = e.clientX - cropState.x;
        startY = e.clientY - cropState.y;
    };
    document.onmousemove = e => {
        if(!isDragging) return;
        e.preventDefault();
        cropState.x = e.clientX - startX;
        cropState.y = e.clientY - startY;
        updateCropView();
    };
    document.onmouseup = () => { isDragging = false; };

    // --- TOUCH EVENTS (FOR MOBILE) ---
    cropBox.ontouchstart = e => {
        // e.preventDefault(); // allow scrolling if needed, but here we capture
        isDragging = true;
        const touch = e.touches[0];
        startX = touch.clientX - cropState.x;
        startY = touch.clientY - cropState.y;
    };
    
    cropBox.ontouchmove = e => {
        if(!isDragging) return;
        e.preventDefault(); // Stop screen from scrolling while panning image
        const touch = e.touches[0];
        cropState.x = touch.clientX - startX;
        cropState.y = touch.clientY - startY;
        updateCropView();
    };

    cropBox.ontouchend = () => { isDragging = false; };

    // --- WHEEL ZOOM (Desktop) ---
    cropBox.onwheel = e => {
        e.preventDefault();
        const zoomSpeed = 0.05; 
        if(e.deltaY < 0) {
            cropState.scale += zoomSpeed;
        } else {
            cropState.scale -= zoomSpeed;
        }
        cropState.scale = Math.max(0.1, cropState.scale);
        updateCropView();
    };
}

function applyCrop(){
if(currentInner){
// Save state back to the original element
currentInner.dataset.x = cropState.x;
currentInner.dataset.y = cropState.y;
currentInner.dataset.scale = cropState.scale;
applyTransform(currentInner);
}
closeCrop();
}

function closeCrop(){
cropModal.style.display = "none";
document.onmousemove = null; 
cropBox.onmousedown = null;
cropBox.ontouchstart = null;
cropBox.ontouchmove = null;
}

/* MAIN PHOTO LOADING LOGIC */
photoInput.addEventListener("change",e=>{
area1.innerHTML="";
area2.innerHTML="";
const files=[...e.target.files];
if(files.length<1) return;

files.forEach((file,index)=>{
const reader=new FileReader();
reader.onload=ev=>{

const div=document.createElement("div");
div.className="photo";

const inner=document.createElement("div");
inner.className="inner";
// Init default values
inner.dataset.x = 0;
inner.dataset.y = 0;
inner.dataset.scale = 1;

const img=document.createElement("img");
img.src=ev.target.result;

inner.appendChild(img);
div.appendChild(inner);

// AUTO FIT LOGIC
img.onload = function(){
const boxW = div.clientWidth;
const boxH = div.clientHeight;
const imgW = img.naturalWidth;
const imgH = img.naturalHeight;

if(!boxW || !boxH || !imgW || !imgH) return;

const scale = Math.max(boxW/imgW, boxH/imgH);

inner.dataset.scale = scale;
// Center the image
inner.dataset.x = (boxW - imgW*scale)/2;
inner.dataset.y = (boxH - imgH*scale)/2;

applyTransform(inner);
};

enableReorder(div);

/* CLICK TO SWAP LOGIC */
div.onclick=()=>{
if(!selected){
selected=div;
div.classList.add("selected");
}
else if(selected === div){
    // Deselect if clicked again
    selected.classList.remove("selected");
    selected = null;
}
else{
// Swap Logic
const selInner = selected.querySelector(".inner");
const targetInner = div.querySelector(".inner");
const tempSrc = selInner.querySelector("img").src;
const tempX = selInner.dataset.x;
const tempY = selInner.dataset.y;
const tempScale = selInner.dataset.scale;

selInner.querySelector("img").src = targetInner.querySelector("img").src;
selInner.dataset.x = targetInner.dataset.x;
selInner.dataset.y = targetInner.dataset.y;
selInner.dataset.scale = targetInner.dataset.scale;
applyTransform(selInner);

targetInner.querySelector("img").src = tempSrc;
targetInner.dataset.x = tempX;
targetInner.dataset.y = tempY;
targetInner.dataset.scale = tempScale;
applyTransform(targetInner);

selected.classList.remove("selected");
selected=null;
}
};

/* DOUBLE CLICK TO CROP (Works as Double Tap on mobile) */
let lastTap = 0;
div.addEventListener('touchend', function(e) {
    const currentTime = new Date().getTime();
    const tapLength = currentTime - lastTap;
    if (tapLength < 300 && tapLength > 0) {
        e.preventDefault();
        openCrop(inner, div);
    }
    lastTap = currentTime;
});

div.ondblclick = (e) => {
e.stopPropagation(); 
openCrop(inner, div);
};

if(index===0) area1.appendChild(div);
else area2.appendChild(div);
};
reader.readAsDataURL(file);
});
setTimeout(()=>{
    applyLayout(files.length-1);
    // Recalculate layout size for scaling logic
    scaleCanvas();
}, 200);
});

/* LAYOUT ENGINE */
function applyLayout(count){
area2.style.gridTemplateColumns="";
[...area2.children].forEach(el=>{
el.style.gridRow="";
el.style.gridColumn="";
});
if(count==1) area2.style.gridTemplateColumns="1fr";
else if(count==2) area2.style.gridTemplateColumns="repeat(2,1fr)";
else if(count==3){
area2.style.gridTemplateColumns="2fr 1fr";
area2.children[0].style.gridRow="span 2";
}
else if(count==4) area2.style.gridTemplateColumns="repeat(2,1fr)";
else if(count==5){
area2.style.gridTemplateColumns="repeat(2,1fr)";
area2.children[4].style.gridColumn="span 2";
}
else if(count==6) area2.style.gridTemplateColumns="repeat(3,1fr)";
else if(count==7){
area2.style.gridTemplateColumns="repeat(3,1fr)";
area2.children[6].style.gridColumn="span 3";
}
else area2.style.gridTemplateColumns="repeat(4,1fr)";
}

/* DATE & TEXT */
function updateDateSize(val){
document.getElementById("overlay-date").style.fontSize=val+"rem";
document.getElementById("overlay-year").style.fontSize=val+"rem";
}
document.getElementById("input-date").oninput=e=>document.getElementById("overlay-date").innerText=e.target.value;
document.getElementById("input-year").oninput=e=>document.getElementById("overlay-year").innerText=e.target.value;
const paraInput=document.getElementById("input-msg");
const paraOverlay=document.getElementById("overlay-para");
paraOverlay.innerText=paraInput.value;
paraInput.addEventListener("input",()=>paraOverlay.innerText=paraInput.value);
function updateNames(){
document.getElementById("overlay-names").innerHTML=
document.getElementById("input-name1").value+"‚ù£Ô∏è"+
document.getElementById("input-name2").value;
}
document.getElementById("input-name1").oninput=updateNames;
document.getElementById("input-name2").oninput=updateNames;

/* DOWNLOAD - Reset Scale for Clean Capture */
function downloadImage(){
    // Temporarily remove scale to ensure full HD capture
    const currentTransform = canvas.style.transform;
    canvas.style.transform = "none";
    window.scrollTo(0,0);

    html2canvas(document.getElementById("canvas"),{
        scale:2,
        useCORS:true,
        backgroundColor:"#000",
        width:800,
        height:1130,
        scrollY: 0,
    }).then(canvasEl=>{
        const link=document.createElement("a");
        link.download="anniversary_collage.jpg";
        link.href=canvasEl.toDataURL("image/jpeg", 0.9);
        link.click();
        
        // Restore scale for UI
        canvas.style.transform = currentTransform;
    }).catch(err => {
        console.error(err);
        canvas.style.transform = currentTransform;
    });
}

</script>
</body>
</html>